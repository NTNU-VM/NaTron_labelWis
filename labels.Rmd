---
title: ""
author: ""
date: ""
geometry: "left=4cm,right=4cm,top=2cm,bottom=2cm"
output: pdf_document
---

```{r setup, include=TRUE, echo=FALSE,message=FALSE}
#devtools::install_github("hrbrmstr/qrencoder")
library(qrencoder)
library(uuid)
library(jsonlite)
library(dplyr)
library(knitr)
outwidth <- input$imagesize
knitr::opts_chunk$set(#fig.align="left",
                      #out.width = paste0(outwidth,"%"),
                      dpi=150,
                      dev='pdf') 
```

----------------------------------------------------------
**Parameters chosen for this print:**
Colletion: `r paste(input$x)`|
Dataset: `r paste(input$dataset)` |
Textsize: `r paste(input$textsize)` |
labelsize: `r paste(input$imagesize)` |
RecordNumber's: `r paste(input$recordNumber[1])` to `r paste(input$recordNumber[2])`

----------------------------------------------------------

```{r plot, include=TRUE,echo=FALSE}

# define parameters for label
inndata_selected <- inndata_selected()
inndata_to_QR <- inndata_selected %>% select(materialSampleID)
textSize <- input$textsize
marg1 <- input$labelMargin
N <- dim(inndata_selected)[1]
sessionID <- UUIDgenerate() # get uniqe ID of the pdf in to identify tempfiles genererated here
  
# loop through all records and print label as .jpeg to tempdir
for(i in 1:N){
  QRcode <- toJSON(data.frame(materialSampleID=inndata_to_QR[1,])) # data to QR code
  prst_s1 <- paste("recordNumber:",inndata_selected$recordNumber[i])
  prst_s2 <- paste("catalogNumber:",inndata_selected$catalogNumber[i])
  prst_s3 <- paste("scientificName:",inndata_selected$scientificName[i])
  prst_s4 <- paste("collectionCode:",inndata_selected$collectionCode[i])
      
  # A temp file to save the output.
  # This file will be removed later by renderImage
  #outfile <- tempfile(fileext = '.jpeg')
  tempdir1 <- tempdir()
  labelname <- paste0(sessionID,sprintf("label_%04d.jpeg", i))
  filepath <- paste0(tempdir1,"/",labelname)    
  # Generate the jpeg (initiate grapich device - printing figure to jpg)
  # and set specifications
  jpeg(filename = filepath,
        width = input$labelWidth, height = input$labelHeigth, units = "mm", pointsize = 8,
        quality = 75,res=150,
        bg = "white")
    
  # choose label text according to label_template imput from UI
  if (input$label_template=="QR only"){
    f_plot_label(QRcode,textSize,marg1) 
  }
  if (input$label_template=="QR + text"){
    f_plot_label(QRcode,textSize,marg1,prst_s1,prst_s2,prst_s3,prst_s4) 
  }
  if (input$label_template=="QR + catalogNumber & collectionCode"){
    f_plot_label(QRcode,textSize,marg1,prst_s2,prst_s4) 
  }
  dev.off() # shut down graphic device 
}

# list all files genereated in this session
labelstoplot <-list.files(tempdir(), pattern = sessionID, full.names = TRUE)
include_graphics(labelstoplot)

#file.remove(labelstoplot)

```

